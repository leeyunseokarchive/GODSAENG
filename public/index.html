<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
    />
    <meta name="theme-color" content="#ffffff" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="Todo" />
    <title>GODSAENG Todo</title>
    <link rel="manifest" href="/manifest.json" />
    <link rel="shortcut icon" href="/icons/icon-36-v2(TP).png" sizes="36x36" type="image/png">
    <link rel="icon" href="/icons/icon-36-v2(TP).png" sizes="36x36" type="image/png">
    <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png?v=2" />
    <link rel="apple-touch-startup-image" href="/splash/splash-640x1136.png" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" />
    <link rel="apple-touch-startup-image" href="/splash/splash-1136x640.png" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" />
    <link rel="apple-touch-startup-image" href="/splash/splash-750x1334.png" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" />
    <link rel="apple-touch-startup-image" href="/splash/splash-1334x750.png" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" />
    <link rel="apple-touch-startup-image" href="/splash/splash-828x1792.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" />
    <link rel="apple-touch-startup-image" href="/splash/splash-1792x828.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" />
    <link rel="apple-touch-startup-image" href="/splash/splash-1125x2436.png" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" />
    <link rel="apple-touch-startup-image" href="/splash/splash-2436x1125.png" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" />
    <link rel="apple-touch-startup-image" href="/splash/splash-1170x2532.png" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" />
    <link rel="apple-touch-startup-image" href="/splash/splash-2532x1170.png" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" />
    <link rel="apple-touch-startup-image" href="/splash/splash-1179x2556.png" media="(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" />
    <link rel="apple-touch-startup-image" href="/splash/splash-2556x1179.png" media="(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" />
    <link rel="apple-touch-startup-image" href="/splash/splash-1242x2208.png" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" />
    <link rel="apple-touch-startup-image" href="/splash/splash-2208x1242.png" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" />
    <link rel="apple-touch-startup-image" href="/splash/splash-1242x2688.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" />
    <link rel="apple-touch-startup-image" href="/splash/splash-2688x1242.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" />
    <link rel="apple-touch-startup-image" href="/splash/splash-1284x2778.png" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" />
    <link rel="apple-touch-startup-image" href="/splash/splash-2778x1284.png" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" />
    <link rel="apple-touch-startup-image" href="/splash/splash-1290x2796.png" media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" />
    <link rel="apple-touch-startup-image" href="/splash/splash-2796x1290.png" media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" />
    <link rel="apple-touch-startup-image" href="/splash/splash-1536x2048.png" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" />
    <link rel="apple-touch-startup-image" href="/splash/splash-2048x1536.png" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" />
    <link rel="apple-touch-startup-image" href="/splash/splash-1668x2224.png" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" />
    <link rel="apple-touch-startup-image" href="/splash/splash-2224x1668.png" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" />
    <link rel="apple-touch-startup-image" href="/splash/splash-1668x2388.png" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" />
    <link rel="apple-touch-startup-image" href="/splash/splash-2388x1668.png" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" />
    <link rel="apple-touch-startup-image" href="/splash/splash-2048x2732.png" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" />
    <link rel="apple-touch-startup-image" href="/splash/splash-2732x2048.png" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        color-scheme: light;
        --bg: #ffffff;
        --surface: #ffffff;
        --ink: #111111;
        --muted: #6a6a6a;
        --line: #e5e5e5;
        --accent: #111111;
        --shadow: 0 22px 40px rgba(17, 17, 17, 0.08);
        --radius: 18px;
      }

      * {
        box-sizing: border-box;
      }

      html,
      body {
        margin: 0;
        font-family: "Noto Sans KR", system-ui, sans-serif;
        background: var(--bg);
        color: var(--ink);
        height: 100%;
        overflow: hidden;
        overflow-x: hidden;
        touch-action: manipulation;
      }

      .page {
        padding: 28px 18px 24px;
        max-width: 520px;
        margin: 0 auto;
        height: 100vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      header {
        display: flex;
        flex-direction: column;
        gap: 6px;
        margin-bottom: 22px;
      }

      header .title {
        font-family: "Noto Sans KR", sans-serif;
        font-size: 28px;
        font-weight: 600;
        letter-spacing: -0.02em;
        cursor: pointer;
      }

      .date-row {
        display: flex;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
        margin-top: 6px;
      }

      .date-row .nav-group {
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .date-row .nav-btn {
        border: 1px solid var(--line);
        background: #ffffff;
        width: 28px;
        height: 28px;
        border-radius: 10px;
        cursor: pointer;
        font-size: 14px;
        line-height: 1;
      }

      .calendar-header .nav-btn {
        width: 28px;
        height: 28px;
        border-radius: 10px;
        border: 1px solid var(--line);
        background: #ffffff;
        color: var(--ink);
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }

      .date-row .date-center {
        display: grid;
        gap: 2px;
        font-size: 14px;
        font-weight: 500;
        color: var(--ink);
        min-width: 130px;
        text-align: center;
      }

      .date-row .date-center .today {
        font-size: 11px;
        color: var(--muted);
        font-weight: 500;
        letter-spacing: 0.08em;
        min-height: 14px;
      }

      .date-row .date-center .today.hidden {
        visibility: hidden;
      }

      .icon-link {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 28px;
        height: 28px;
        border-radius: 10px;
        border: 1px solid var(--line);
        background: #ffffff;
        color: var(--ink);
        text-decoration: none;
        margin-left: auto;
      }

      .sections {
        display: grid;
        gap: 16px;
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden;
        overscroll-behavior: contain;
        align-content: start;
        align-items: start;
      }

      .section {
        background: var(--surface);
        border-radius: var(--radius);
        padding: 16px;
        border: 1px solid var(--line);
        animation: rise 0.5s ease both;
      }

      .section.memo .memo-list {
        display: grid;
        gap: 10px;
      }

      .section.memo .memo-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px;
        border-radius: 14px;
        border: 1px solid var(--line);
        background: #ffffff;
      }

      .section.memo .memo-item .text {
        flex: 1;
        font-size: 14px;
        white-space: pre-wrap;
        overflow-wrap: anywhere;
      }

      .section.memo .memo-item .delete {
        border: 1px solid var(--line);
        background: #ffffff;
        width: 28px;
        height: 28px;
        border-radius: 10px;
        cursor: pointer;
        font-size: 14px;
        line-height: 1;
        color: var(--muted);
      }

      .modal {
        position: fixed;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 20;
      }

      .modal.hidden {
        display: none;
      }

      .modal-backdrop {
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0.35);
      }

      .modal-card {
        position: relative;
        background: #ffffff;
        border: 1px solid var(--line);
        border-radius: 16px;
        padding: 18px;
        width: min(320px, 90vw);
        display: grid;
        gap: 12px;
        box-shadow: var(--shadow);
      }

      .modal-title {
        font-size: 14px;
        font-weight: 600;
      }

      .modal-actions {
        display: grid;
        gap: 8px;
      }

      .modal-actions button {
        width: 100%;
        height: 40px;
        border-radius: 12px;
        border: 1px solid var(--line);
        background: #ffffff;
        cursor: pointer;
        font-size: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
      }

      .modal-actions .danger {
        background: var(--accent);
        color: #ffffff;
        border: none;
      }

      .calendar-card {
        width: min(420px, 92vw);
      }

      .calendar-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
      }

      .calendar-title {
        font-size: 14px;
        font-weight: 600;
      }

      .calendar-weekdays,
      .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 6px;
      }

      .calendar-weekdays {
        font-size: 11px;
        color: var(--muted);
        text-align: center;
        margin-top: 10px;
      }

      .calendar-grid {
        margin-top: 8px;
      }

      .calendar-day {
        border: 1px solid var(--line);
        background: #ffffff;
        border-radius: 10px;
        padding: 6px;
        height: 72px;
        display: grid;
        gap: 4px;
        cursor: pointer;
        text-align: left;
        align-items: start;
        align-content: start;
      }

      .calendar-weekdays > div {
        text-align: center;
      }

      .calendar-day.outside {
        opacity: 0.35;
      }

      .calendar-day .num {
        font-size: 11px;
        font-weight: 600;
      }

      .calendar-todos {
        display: grid;
        gap: 2px;
        align-content: start;
      }

      .calendar-todo {
        font-size: 9px;
        color: var(--muted);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: clip;
      }

      .modal-field {
        display: grid;
        gap: 8px;
      }

      .modal-field input {
        width: 100%;
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid var(--line);
        font-size: 16px;
        font-family: inherit;
        background: #ffffff;
      }

      .section header {
        margin: 0 0 12px;
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }

      .section h2 {
        margin: 0;
        font-size: 16px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
        text-align: left;
        white-space: nowrap;
      }

      .section .range {
        font-size: 12px;
        color: var(--muted);
      }

      .section .add-toggle {
        border: 1px solid var(--line);
        background: #ffffff;
        width: 28px;
        height: 28px;
        border-radius: 10px;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        margin-left: auto;
      }

      .section .adder {
        display: grid;
        gap: 8px;
        margin-bottom: 12px;
      }

      .section .adder.hidden {
        display: none;
      }

      .section .adder input {
        width: 100%;
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid var(--line);
        font-size: 16px;
        font-family: inherit;
        background: #ffffff;
      }

      .section .adder input:focus {
        outline: 2px solid rgba(27, 27, 27, 0.12);
        border-color: rgba(27, 27, 27, 0.3);
        background: #ffffff;
      }

      .section .adder .row {
        display: grid;
        grid-template-columns: 1fr 1.4fr;
        gap: 8px;
      }

      .section .adder .memo-group {
        display: flex;
        gap: 8px;
        align-items: center;
      }

      .section .adder .memo-group input {
        flex: 1;
      }

      .section .adder button {
        padding: 10px 12px;
        border-radius: 12px;
        border: none;
        background: var(--accent);
        color: #ffffff;
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        height: 40px;
        min-width: 40px;
      }

      .icon,
      .period-icon {
        width: 18px;
        height: 18px;
        display: inline-block;
        fill: currentColor;
        vertical-align: middle;
      }

      .pin-icon {
        width: 16px;
        height: 16px;
        transform: none;
      }

      .fit-text {
        white-space: nowrap;
        overflow: hidden;
      }

      input.fit-text {
        text-overflow: clip;
      }

      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        border: 0;
      }

      button,
      a {
        color: var(--ink);
        touch-action: manipulation;
      }

      .list {
        display: grid;
        gap: 10px;
        padding-bottom: 0;
      }

      .todo {
        display: grid;
        grid-template-columns: auto 1fr auto;
        gap: 10px;
        padding: 12px;
        border-radius: 14px;
        background: var(--surface);
        border: 1px solid var(--line);
        transition: transform 0.2s ease, opacity 0.2s ease;
      }

      .todo.checked {
        opacity: 0.55;
      }

      .todo label {
        display: grid;
        gap: 6px;
      }

      .todo .title {
        font-size: 15px;
        font-weight: 500;
      }

      .todo .meta {
        font-size: 12px;
        color: var(--muted);
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .todo input[type="checkbox"] {
        width: 20px;
        height: 20px;
        accent-color: var(--accent);
        margin-top: 4px;
      }

      .todo .actions {
        display: flex;
        gap: 6px;
        justify-content: center;
        align-items: center;
      }

      .todo.checked .actions {
        opacity: 1;
      }

      .todo .move {
        border: 1px solid var(--line);
        background: #ffffff;
        width: 28px;
        height: 28px;
        border-radius: 10px;
        cursor: pointer;
        font-size: 14px;
        line-height: 1;
      }

      .todo .pin {
        border: 1px solid var(--line);
        background: #ffffff;
        width: 28px;
        height: 28px;
        border-radius: 10px;
        cursor: pointer;
        font-size: 14px;
        line-height: 1;
      }

      .todo .delete {
        border: 1px solid var(--line);
        background: #ffffff;
        width: 28px;
        height: 28px;
        border-radius: 10px;
        cursor: pointer;
        font-size: 14px;
        line-height: 1;
        color: var(--muted);
      }

      .todo .save {
        border: none;
        background: var(--accent);
        color: #ffffff;
        width: 28px;
        height: 28px;
        border-radius: 10px;
        cursor: pointer;
        font-size: 14px;
        line-height: 1;
      }

      .todo .cancel {
        border: 1px solid var(--line);
        background: #ffffff;
        width: 28px;
        height: 28px;
        border-radius: 10px;
        cursor: pointer;
        font-size: 14px;
        line-height: 1;
      }

      .todo .edit-fields {
        display: grid;
        gap: 8px;
      }

      .todo .edit-fields input {
        width: 100%;
        padding: 8px 10px;
        border-radius: 10px;
        border: 1px solid var(--line);
        font-size: 14px;
        font-family: inherit;
        background: #ffffff;
      }

      .todo .edit-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 6px;
      }

      .empty {
        font-size: 13px;
        color: var(--muted);
        padding: 0 2px;
      }

      @media (max-width: 480px) {
        .page {
          padding: 24px 14px 16px;
        }

        .section .adder .row {
          grid-template-columns: 1fr;
        }

        .date-row {
          gap: 6px;
        }
      }

      @keyframes rise {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

    </style>
  </head>
  <body>
    <main class="page">
      <header>
        <div class="title">TODO</div>
        <div class="date-row">
          <div class="nav-group">
            <button class="nav-btn" id="date-prev" type="button" aria-label="Previous date">
              ◀
            </button>
            <div class="date-center" id="date-center"></div>
            <button class="nav-btn" id="date-next" type="button" aria-label="Next date">
              ▶
            </button>
          </div>
          <button class="icon-link" id="calendar-open" type="button" aria-label="Open calendar">
            <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
              <path
                d="M7 3a1 1 0 0 1 1 1v1h8V4a1 1 0 1 1 2 0v1h1.5A2.5 2.5 0 0 1 22 7.5v11A2.5 2.5 0 0 1 19.5 21h-15A2.5 2.5 0 0 1 2 18.5v-11A2.5 2.5 0 0 1 4.5 5H6V4a1 1 0 0 1 1-1Zm12.5 7h-15v8.5c0 .28.22.5.5.5h15a.5.5 0 0 0 .5-.5V10Z"
              />
            </svg>
          </button>
        </div>
      </header>

      <section class="sections" id="sections"></section>
    </main>

    <div class="modal hidden" id="calendar-modal" role="dialog" aria-modal="true">
      <div class="modal-backdrop" data-action="cancel"></div>
      <div class="modal-card calendar-card">
        <div class="calendar-header">
          <button class="nav-btn" id="calendar-prev" type="button" aria-label="Previous month">
            ◀
          </button>
          <div class="calendar-title" id="calendar-title">2025.12</div>
          <button class="nav-btn" id="calendar-next" type="button" aria-label="Next month">
            ▶
          </button>
        </div>
        <div class="calendar-weekdays">
          <div>SUN</div><div>MON</div><div>TUE</div><div>WED</div><div>THU</div><div>FRI</div><div>SAT</div>
        </div>
        <div class="calendar-grid" id="calendar-grid"></div>
      </div>
    </div>


    <div class="modal hidden" id="pin-action-modal" role="dialog" aria-modal="true">
      <div class="modal-backdrop" data-action="cancel"></div>
      <div class="modal-card">
        <div class="modal-title" id="pin-modal-title">PINNED ROUTINE</div>
        <div class="modal-actions">
          <button class="danger" data-action="all" id="pin-modal-all">
            Delete All
          </button>
          <button data-action="future" id="pin-modal-future">
            Delete from Today
          </button>
          <button data-action="today" id="pin-modal-today">Today Only</button>
          <button data-action="cancel">Cancel</button>
        </div>
      </div>
    </div>

    <div class="modal hidden" id="todo-edit-modal" role="dialog" aria-modal="true">
      <div class="modal-backdrop" data-action="cancel"></div>
      <div class="modal-card">
        <div class="modal-title">EDIT TODO</div>
        <div class="modal-field">
          <input id="todo-edit-title" type="text" placeholder="NAME" />
          <input id="todo-edit-time" type="time" />
          <input id="todo-edit-memo" type="text" placeholder="MEMO (optional)" />
        </div>
        <div class="modal-actions">
          <button class="danger" data-action="save">Save</button>
          <button data-action="cancel">Cancel</button>
        </div>
      </div>
    </div>

    <div class="modal hidden" id="memo-edit-modal" role="dialog" aria-modal="true">
      <div class="modal-backdrop" data-action="cancel"></div>
      <div class="modal-card">
        <div class="modal-title">EDIT MEMO</div>
        <div class="modal-field">
          <input id="memo-edit-text" type="text" placeholder="MEMO" />
        </div>
        <div class="modal-actions">
          <button class="danger" data-action="save">Save</button>
          <button data-action="cancel">Cancel</button>
        </div>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
      import {
        getFirestore,
        doc,
        setDoc,
        onSnapshot,
        serverTimestamp,
      } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyCngHRQF5RAA-_98Xfv08AXRfUZNB9bNRI",
        authDomain: "swipetodo.firebaseapp.com",
        projectId: "swipetodo",
        storageBucket: "swipetodo.firebasestorage.app",
        messagingSenderId: "245873687078",
        appId: "1:245873687078:web:a9b6facdea2eb2587fc4e7",
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      let lastTouchEnd = 0;
      document.addEventListener("gesturestart", (event) => event.preventDefault());
      document.addEventListener("gesturechange", (event) => event.preventDefault());
      document.addEventListener("gestureend", (event) => event.preventDefault());
      document.addEventListener(
        "touchend",
        (event) => {
          if (event.target.closest("input, textarea, [contenteditable='true']")) {
            lastTouchEnd = Date.now();
            return;
          }
          const now = Date.now();
          if (now - lastTouchEnd <= 300) {
            event.preventDefault();
          }
          lastTouchEnd = now;
        },
        { passive: false }
      );
      const PERIODS = [
        { id: "morning", label: "MORNING", range: "06-12" },
        { id: "lunch", label: "LUNCH", range: "12-18" },
        { id: "evening", label: "DINNER", range: "18-06" },
      ];

      const STORAGE_KEY = "todays-todos";

      const dateCenter = document.getElementById("date-center");
      const datePrev = document.getElementById("date-prev");
      const dateNext = document.getElementById("date-next");
      const sectionsEl = document.getElementById("sections");
      const titleEl = document.querySelector("header .title");
      const calendarOpen = document.getElementById("calendar-open");
      const calendarModal = document.getElementById("calendar-modal");
      const calendarGrid = document.getElementById("calendar-grid");
      const calendarTitle = document.getElementById("calendar-title");
      const calendarPrev = document.getElementById("calendar-prev");
      const calendarNext = document.getElementById("calendar-next");
      const pinActionModal = document.getElementById("pin-action-modal");
      const pinModalTitle = document.getElementById("pin-modal-title");
      const pinModalAll = document.getElementById("pin-modal-all");
      const pinModalFuture = document.getElementById("pin-modal-future");
      const pinModalToday = document.getElementById("pin-modal-today");
      const todoEditModal = document.getElementById("todo-edit-modal");
      const todoEditTitle = document.getElementById("todo-edit-title");
      const todoEditTime = document.getElementById("todo-edit-time");
      const todoEditMemo = document.getElementById("todo-edit-memo");
      const memoEditModal = document.getElementById("memo-edit-modal");
      const memoEditText = document.getElementById("memo-edit-text");

      [todoEditTitle, todoEditMemo, memoEditText].forEach((input) => {
        input.classList.add("fit-text");
        input.dataset.fitMin = "12";
        input.addEventListener("input", () => fitText(input, 12));
      });

      const state = loadState();
      const openAdders = {};
      let openMemoAdder = false;
      let selectedDate = getTodayKey();
      let calendarMonth = new Date();
      let activeUnsubscribe = null;
      let activePinsUnsubscribe = null;
      let activePinStatusUnsubscribe = null;
      let activeMemoUnsubscribe = null;

      function loadState() {
        const raw = localStorage.getItem(STORAGE_KEY);
        const today = getTodayKey();
        if (!raw) {
          return {
            itemsByDate: { [today]: [] },
            pinnedItems: [],
            pinStatusByDate: {},
            memoItemsByDate: {},
          };
        }
        try {
          const parsed = JSON.parse(raw);
          if (parsed.itemsByDate) {
            return {
              itemsByDate: parsed.itemsByDate,
              pinnedItems: parsed.pinnedItems || [],
              pinStatusByDate: parsed.pinStatusByDate || {},
              memoItemsByDate: parsed.memoItemsByDate || {},
            };
          }
          if (parsed.date && Array.isArray(parsed.items)) {
            return {
              itemsByDate: { [parsed.date]: parsed.items },
              pinnedItems: [],
              pinStatusByDate: {},
              memoItemsByDate: {},
            };
          }
          return {
            itemsByDate: { [today]: [] },
            pinnedItems: [],
            pinStatusByDate: {},
            memoItemsByDate: {},
          };
        } catch (error) {
          return {
            itemsByDate: { [today]: [] },
            pinnedItems: [],
            pinStatusByDate: {},
            memoItemsByDate: {},
          };
        }
      }

      function saveState(dateKey = selectedDate, options = { remote: true }) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        if (options.remote) {
          syncDateToRemote(dateKey);
        }
      }

      function savePinsState(options = { remote: true }) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        if (options.remote) {
          syncPinsToRemote();
        }
      }

      function savePinStatus(dateKey = selectedDate, options = { remote: true }) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        if (options.remote) {
          syncPinStatusToRemote(dateKey);
        }
      }

      function saveMemoState(dateKey = selectedDate, options = { remote: true }) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        if (options.remote) {
          syncMemoToRemote(dateKey);
        }
      }

      function syncDateToRemote(dateKey) {
        const items = getItemsForDate(dateKey);
        setDoc(
          doc(db, "todos", dateKey),
          {
            items,
            updatedAt: serverTimestamp(),
          },
          { merge: true }
        )
          .catch((error) => console.warn("Firestore save failed", error));
      }

      function syncPinsToRemote() {
        setDoc(
          doc(db, "pins", "list"),
          {
            items: state.pinnedItems,
            updatedAt: serverTimestamp(),
          },
          { merge: true }
        ).catch((error) => console.warn("Firestore pins save failed", error));
      }

      function syncPinStatusToRemote(dateKey) {
        const status = state.pinStatusByDate[dateKey] || {};
        setDoc(
          doc(db, "pinStatus", dateKey),
          {
            status,
            updatedAt: serverTimestamp(),
          },
          { merge: true }
        ).catch((error) => console.warn("Firestore pin status save failed", error));
      }

      function syncMemoToRemote(dateKey) {
        const items = state.memoItemsByDate[dateKey] || [];
        setDoc(
          doc(db, "memos", dateKey),
          {
            items,
            updatedAt: serverTimestamp(),
          },
          { merge: true }
        ).catch((error) => console.warn("Firestore memo save failed", error));
      }

      function subscribeToDate(dateKey) {
        if (activeUnsubscribe) activeUnsubscribe();
        activeUnsubscribe = onSnapshot(doc(db, "todos", dateKey), (snapshot) => {
          if (!snapshot.exists()) return;
          const data = snapshot.data() || {};
          const items = Array.isArray(data.items) ? data.items : [];
          state.itemsByDate[dateKey] = items;
          saveState(dateKey, { remote: false });
          render();
        });
      }

      function subscribePins() {
        if (activePinsUnsubscribe) activePinsUnsubscribe();
        activePinsUnsubscribe = onSnapshot(doc(db, "pins", "list"), (snapshot) => {
          if (!snapshot.exists()) return;
          const data = snapshot.data() || {};
          const items = Array.isArray(data.items) ? data.items : [];
          state.pinnedItems = items;
          savePinsState({ remote: false });
          render();
        });
      }

      function subscribePinStatus(dateKey) {
        if (activePinStatusUnsubscribe) activePinStatusUnsubscribe();
        activePinStatusUnsubscribe = onSnapshot(
          doc(db, "pinStatus", dateKey),
          (snapshot) => {
            if (!snapshot.exists()) return;
            const data = snapshot.data() || {};
            state.pinStatusByDate[dateKey] = data.status || {};
            savePinStatus(dateKey, { remote: false });
            render();
          }
        );
      }

      function subscribeMemo(dateKey) {
        if (activeMemoUnsubscribe) activeMemoUnsubscribe();
        activeMemoUnsubscribe = onSnapshot(doc(db, "memos", dateKey), (snapshot) => {
          if (!snapshot.exists()) return;
          const data = snapshot.data() || {};
          state.memoItemsByDate[dateKey] = Array.isArray(data.items) ? data.items : [];
          saveMemoState(dateKey, { remote: false });
          render();
        });
      }

      function createId() {
        if (window.crypto && window.crypto.randomUUID) {
          return window.crypto.randomUUID();
        }
        return `todo-${Date.now()}-${Math.random().toString(16).slice(2)}`;
      }

      function getTodayKey() {
        return new Date().toISOString().slice(0, 10);
      }

      function formatDateLabel() {
        const [year, month, day] = selectedDate.split("-");
        const date = new Date(selectedDate);
        const dayLabel = ["SUN", "MON", "TUE", "WED", "THU", "FRI", "SAT"][
          date.getDay()
        ];
        return `${year.slice(2)}.${month}.${day} ${dayLabel}`;
      }

      function toDateKey(value) {
        if (!value) return "";
        const date = new Date(value);
        if (Number.isNaN(date.getTime())) return "";
        return date.toISOString().slice(0, 10);
      }

      function formatMonthLabel(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, "0");
        return `${year}.${month}`;
      }

      function fitText(element, minSize = 10) {
        if (!element) return;
        const maxSize =
          Number(element.dataset.fitMax) ||
          parseFloat(window.getComputedStyle(element).fontSize) ||
          14;
        let size = maxSize;
        element.style.fontSize = `${size}px`;
        while (element.scrollWidth > element.clientWidth && size > minSize) {
          size -= 0.5;
          element.style.fontSize = `${size}px`;
        }
      }

      function fitAllText() {
        document.querySelectorAll(".fit-text").forEach((element) => {
          const min = Number(element.dataset.fitMin) || 10;
          fitText(element, min);
        });
      }

      function renderCalendar() {
        calendarGrid.innerHTML = "";
        const year = calendarMonth.getFullYear();
        const month = calendarMonth.getMonth();
        calendarTitle.textContent = formatMonthLabel(calendarMonth);

        const start = new Date(year, month, 1);
        const startDay = start.getDay();
        const startDate = new Date(year, month, 1 - startDay);

        for (let i = 0; i < 42; i += 1) {
          const current = new Date(startDate);
          current.setDate(startDate.getDate() + i);
          const inMonth = current.getMonth() === month;
          const dateKey = `${current.getFullYear()}-${String(
            current.getMonth() + 1
          ).padStart(2, "0")}-${String(current.getDate()).padStart(2, "0")}`;
          const dayCell = document.createElement("div");
          dayCell.className = `calendar-day${inMonth ? "" : " outside"}`;
          dayCell.dataset.date = dateKey;

          const num = document.createElement("div");
          num.className = "num";
          num.textContent = current.getDate();

          const todosWrap = document.createElement("div");
          todosWrap.className = "calendar-todos";

          const items = (state.itemsByDate[dateKey] || []).slice(0, 3);
          items.forEach((item) => {
            const line = document.createElement("div");
            line.className = "calendar-todo";
            line.textContent = item.title;
            todosWrap.appendChild(line);
          });

          dayCell.appendChild(num);
          dayCell.appendChild(todosWrap);
          calendarGrid.appendChild(dayCell);
        }
      }

      function openCalendar() {
        calendarMonth = new Date(selectedDate);
        renderCalendar();
        calendarModal.classList.remove("hidden");
      }

      function closeCalendar() {
        calendarModal.classList.add("hidden");
      }


      function openPinActionModal({
        title,
        allLabel,
        futureLabel,
        todayLabel,
        hideFuture = false,
        hideToday = false,
      }) {
        return new Promise((resolve) => {
          pinModalTitle.textContent = title;
          pinModalAll.textContent = allLabel;
          pinModalFuture.textContent = futureLabel;
          pinModalFuture.style.display = hideFuture ? "none" : "inline-flex";
          pinModalToday.textContent = todayLabel || "Today Only";
          pinModalToday.style.display = hideToday ? "none" : "inline-flex";
          pinActionModal.classList.remove("hidden");

          const handleClick = (event) => {
            const action = event.target.closest("button, .modal-backdrop")?.dataset
              ?.action;
            if (!action) return;
            cleanup();
            resolve(action);
          };

          const handleKey = (event) => {
            if (event.key === "Escape") {
              cleanup();
              resolve("cancel");
            }
          };

          const cleanup = () => {
            pinActionModal.classList.add("hidden");
            pinActionModal.removeEventListener("click", handleClick);
            pinModalFuture.style.display = "inline-flex";
            pinModalToday.style.display = "inline-flex";
            document.removeEventListener("keydown", handleKey);
          };

          pinActionModal.addEventListener("click", handleClick);
          document.addEventListener("keydown", handleKey);
        });
      }

      function openTodoEditModal(item) {
        return new Promise((resolve) => {
          todoEditTitle.value = item.title || "";
          todoEditTime.value = item.time || "";
          todoEditMemo.value = item.memo || "";
          todoEditTitle.classList.add("fit-text");
          todoEditMemo.classList.add("fit-text");
          todoEditModal.classList.remove("hidden");
          todoEditTitle.focus();
          fitText(todoEditTitle, 10);
          fitText(todoEditMemo, 10);

          const handleClick = (event) => {
            const action = event.target.closest("button, .modal-backdrop")?.dataset
              ?.action;
            if (!action) return;
            if (action === "save") {
              const title = todoEditTitle.value.trim();
              if (!title) return;
              item.title = title;
              item.time = todoEditTime.value;
              item.memo = todoEditMemo.value.trim();
              cleanup();
              resolve("save");
              return;
            }
            cleanup();
            resolve("cancel");
          };

          const handleKey = (event) => {
            if (event.key === "Escape") {
              cleanup();
              resolve("cancel");
            }
            if (event.key === "Enter") {
              event.preventDefault();
              const title = todoEditTitle.value.trim();
              if (!title) return;
              item.title = title;
              item.time = todoEditTime.value;
              item.memo = todoEditMemo.value.trim();
              cleanup();
              resolve("save");
            }
          };

          const cleanup = () => {
            todoEditModal.classList.add("hidden");
            todoEditModal.removeEventListener("click", handleClick);
            document.removeEventListener("keydown", handleKey);
          };

          todoEditModal.addEventListener("click", handleClick);
          document.addEventListener("keydown", handleKey);
        });
      }

      function openMemoEditModal(memo) {
        return new Promise((resolve) => {
          memoEditText.value = memo.text || "";
          memoEditModal.classList.remove("hidden");
          memoEditText.focus();
          fitText(memoEditText, 10);

          const handleClick = (event) => {
            const action = event.target.closest("button, .modal-backdrop")?.dataset
              ?.action;
            if (!action) return;
            if (action === "save") {
              const text = memoEditText.value.trim();
              if (!text) return;
              memo.text = text;
              cleanup();
              resolve("save");
              return;
            }
            cleanup();
            resolve("cancel");
          };

          const handleKey = (event) => {
            if (event.key === "Escape") {
              cleanup();
              resolve("cancel");
            }
            if (event.key === "Enter") {
              event.preventDefault();
              const text = memoEditText.value.trim();
              if (!text) return;
              memo.text = text;
              cleanup();
              resolve("save");
            }
          };

          const cleanup = () => {
            memoEditModal.classList.add("hidden");
            memoEditModal.removeEventListener("click", handleClick);
            document.removeEventListener("keydown", handleKey);
          };

          memoEditModal.addEventListener("click", handleClick);
          document.addEventListener("keydown", handleKey);
        });
      }

      function iconSvg(name) {
        if (name === "plus") {
          return `<svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 5a1 1 0 0 1 1 1v5h5a1 1 0 1 1 0 2h-5v5a1 1 0 1 1-2 0v-5H6a1 1 0 1 1 0-2h5V6a1 1 0 0 1 1-1Z"/></svg>`;
        }
        if (name === "check") {
          return `<svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M9.2 16.2a1 1 0 0 1-1.4 0l-3-3a1 1 0 1 1 1.4-1.4l2.3 2.3 7.3-7.3a1 1 0 0 1 1.4 1.4l-8 8Z"/></svg>`;
        }
        if (name === "pin") {
          return `<svg class="period-icon pin-icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M14 3a1 1 0 0 1 1 1v3.59l2.7 2.7a1 1 0 0 1-.7 1.71H13v6a1 1 0 0 1-2 0v-6H7a1 1 0 0 1-.7-1.71L9 7.59V4a1 1 0 0 1 1-1h4Z"/></svg>`;
        }
        if (name === "pin-off") {
          return `<svg class="icon pin-icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M14 3a1 1 0 0 1 1 1v3.59l2.7 2.7a1 1 0 0 1-.7 1.71H13v6a1 1 0 0 1-2 0v-6H7a1 1 0 0 1-.7-1.71L9 7.59V4a1 1 0 0 1 1-1h4Z"/><path d="M6 21a1 1 0 0 1-1-1v-1h14v1a1 1 0 0 1-1 1H6Z"/></svg>`;
        }
        if (name === "pin-on") {
          return `<svg class="icon pin-icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M14 3a1 1 0 0 1 1 1v3.59l2.7 2.7a1 1 0 0 1-.7 1.71H13v6a1 1 0 0 1-2 0v-6H7a1 1 0 0 1-.7-1.71L9 7.59V4a1 1 0 0 1 1-1h4Z"/><path d="M6 21a1 1 0 0 1-1-1v-1h14v1a1 1 0 0 1-1 1H6Z"/></svg>`;
        }
        if (name === "pencil") {
          return `<svg class="period-icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M15.6 3.9a1.5 1.5 0 0 1 2.1 0l2.4 2.4a1.5 1.5 0 0 1 0 2.1L9.3 19.2 4 20.5a1 1 0 0 1-1.2-1.2l1.3-5.3 10.5-10.1Z"/><path d="M13.5 6.9 17.1 10.5 18.9 8.7 15.3 5.1 13.5 6.9Z"/></svg>`;
        }
        if (name === "morning") {
          return `<svg class="period-icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 5a1 1 0 0 1 1 1v1.06a1 1 0 1 1-2 0V6a1 1 0 0 1 1-1Zm6.36 2.64a1 1 0 0 1 0 1.41l-.75.75a1 1 0 1 1-1.41-1.41l.75-.75a1 1 0 0 1 1.41 0ZM5.8 8.8a1 1 0 0 1-1.41 0l-.75-.75a1 1 0 1 1 1.41-1.41l.75.75a1 1 0 0 1 0 1.41ZM12 9.5a4.5 4.5 0 0 1 4.5 4.5v1a1 1 0 0 1-1 1h-7a1 1 0 0 1-1-1v-1A4.5 4.5 0 0 1 12 9.5Zm8 9a1 1 0 1 1 0 2H4a1 1 0 1 1 0-2h16Z"/></svg>`;
        }
        if (name === "lunch") {
          return `<svg class="period-icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 4a1 1 0 0 1 1 1v1.1a1 1 0 1 1-2 0V5a1 1 0 0 1 1-1Zm7.8 2.9a1 1 0 0 1 0 1.4l-.78.78a1 1 0 1 1-1.41-1.41l.78-.78a1 1 0 0 1 1.41 0ZM6.4 6.3a1 1 0 0 1 1.41 0l.78.78a1 1 0 1 1-1.41 1.41l-.78-.78a1 1 0 0 1 0-1.41ZM4 12a1 1 0 0 1 1 1v.1a1 1 0 1 1-2 0V13a1 1 0 0 1 1-1Zm16 0a1 1 0 0 1 1 1v.1a1 1 0 1 1-2 0V13a1 1 0 0 1 1-1ZM12 9a4 4 0 0 1 4 4v1a1 1 0 0 1-1 1H9a1 1 0 0 1-1-1v-1a4 4 0 0 1 4-4Zm8 9a1 1 0 1 1 0 2H4a1 1 0 1 1 0-2h16Z"/></svg>`;
        }
        if (name === "evening") {
          return `<svg class="period-icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M14.5 3a1 1 0 0 1 .92 1.4A7 7 0 0 0 16 7a7 7 0 0 0 7 7 1 1 0 0 1 .6 1.8A9 9 0 1 1 14.5 3Z"/></svg>`;
        }
        return `<svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M6.2 6.2a1 1 0 0 1 1.4 0L12 10.6l4.4-4.4a1 1 0 1 1 1.4 1.4L13.4 12l4.4 4.4a1 1 0 0 1-1.4 1.4L12 13.4l-4.4 4.4a1 1 0 1 1-1.4-1.4L10.6 12 6.2 7.6a1 1 0 0 1 0-1.4Z"/></svg>`;
      }

      function isValidDateKey(value) {
        if (!value) return false;
        const date = new Date(value);
        return !Number.isNaN(date.getTime());
      }

      function shiftSelectedDate(offsetDays) {
        const date = new Date(selectedDate);
        date.setDate(date.getDate() + offsetDays);
        setSelectedDate(date.toISOString().slice(0, 10));
      }

      function getRelativeLabel() {
        const selected = new Date(selectedDate);
        const today = new Date();
        selected.setHours(0, 0, 0, 0);
        today.setHours(0, 0, 0, 0);
        const diffDays = Math.round((selected - today) / 86400000);
        if (diffDays === -1) return "YESTERDAY";
        if (diffDays === 0) return "TODAY";
        if (diffDays === 1) return "TOMORROW";
        return "-";
      }

      function getNextPeriodId(current) {
        const index = PERIODS.findIndex((p) => p.id === current);
        const next = PERIODS[(index + 1) % PERIODS.length];
        return next.id;
      }

      function getPrevPeriodId(current) {
        const index = PERIODS.findIndex((p) => p.id === current);
        const prev = PERIODS[(index - 1 + PERIODS.length) % PERIODS.length];
        return prev.id;
      }

      function shiftDateKey(dateKey, offsetDays) {
        const date = new Date(dateKey);
        date.setDate(date.getDate() + offsetDays);
        return date.toISOString().slice(0, 10);
      }

      function formatMeta(item) {
        const parts = [];
        if (item.time) parts.push(`${item.time}`);
        if (item.memo) parts.push(`${item.memo}`);
        return parts.join(" · ");
      }

      function isPinVisible(pin, dateKey) {
        const createdKey = toDateKey(pin.createdAt);
        const deletedKey = toDateKey(pin.deletedAt);
        const createdOk = !createdKey || createdKey <= dateKey;
        const deletedOk = !deletedKey || deletedKey > dateKey;
        return createdOk && deletedOk;
      }

      function getPinnedForPeriod(periodId) {
        return state.pinnedItems
          .filter((pin) => pin.periodId === periodId && isPinVisible(pin, selectedDate))
          .slice()
          .sort((a, b) => a.createdAt - b.createdAt)
          .map((pin) => ({
            pinned: true,
            pinId: pin.id,
            title: pin.title,
            time: pin.time,
            memo: pin.memo,
            periodId: pin.periodId,
            createdAt: pin.createdAt,
          }));
      }

      function updatePinStatus(pinId, done) {
        const nextStatus = { ...(state.pinStatusByDate[selectedDate] || {}) };
        if (done) {
          nextStatus[pinId] = true;
        } else {
          delete nextStatus[pinId];
        }
        state.pinStatusByDate[selectedDate] = nextStatus;
        savePinStatus();
        render();
      }

      function applyPinDelete(pin, mode) {
        if (mode === "all") {
          state.pinnedItems = state.pinnedItems.filter((entry) => entry.id !== pin.id);
          Object.keys(state.pinStatusByDate || {}).forEach((dateKey) => {
            if (state.pinStatusByDate[dateKey]) {
              delete state.pinStatusByDate[dateKey][pin.id];
            }
          });
          savePinStatus();
        } else if (mode === "today") {
          const items = getItemsForDate(selectedDate);
          const pinnedDone = !!(state.pinStatusByDate[selectedDate] || {})[pin.id];
          items.push({
            id: createId(),
            title: pin.title,
            time: pin.time,
            memo: pin.memo,
            periodId: pin.periodId,
            done: pinnedDone,
            createdAt: Date.now(),
          });
        } else if (mode === "future") {
          pin.deletedAt = selectedDate;
        }
        savePinsState();
        render();
      }

      function applyPinMove(pin, targetPeriodId, mode) {
        if (mode === "all") {
          pin.periodId = targetPeriodId;
        } else if (mode === "today") {
          const items = getItemsForDate(selectedDate);
          const pinnedDone = !!(state.pinStatusByDate[selectedDate] || {})[pin.id];
          items.push({
            id: createId(),
            title: pin.title,
            time: pin.time,
            memo: pin.memo,
            periodId: targetPeriodId,
            done: pinnedDone,
            createdAt: Date.now(),
          });
        } else if (mode === "future") {
          pin.deletedAt = selectedDate;
          state.pinnedItems.push({
            id: createId(),
            title: pin.title,
            time: pin.time,
            memo: pin.memo,
            periodId: targetPeriodId,
            createdAt: selectedDate,
          });
        }
        savePinsState();
        render();
      }

      function createTodoElement(item) {
        const isPinned = !!item.pinned;
        const pinStatus = state.pinStatusByDate[selectedDate] || {};
        const wrapper = document.createElement("div");
        const isDone = isPinned ? !!pinStatus[item.pinId] : item.done;
        wrapper.className = `todo${isDone ? " checked" : ""}`;

        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.checked = isDone;
        checkbox.addEventListener("change", () => {
          if (isPinned) {
            updatePinStatus(item.pinId, checkbox.checked);
            return;
          }
          item.done = checkbox.checked;
          saveState();
          render();
        });

        const label = document.createElement("label");
        const title = document.createElement("div");
        title.className = "title";
        title.textContent = item.title;
        title.classList.add("fit-text");
        title.dataset.fitMin = "10";

        const meta = document.createElement("div");
        meta.className = "meta";
        meta.textContent = formatMeta(item);
        if (!meta.textContent) {
          meta.style.display = "none";
        }
        meta.classList.add("fit-text");
        meta.dataset.fitMin = "10";

        label.appendChild(title);
        label.appendChild(meta);

        const actions = document.createElement("div");
        actions.className = "actions";

        const pinButton = document.createElement("button");
        pinButton.type = "button";
        pinButton.className = "pin";
        pinButton.setAttribute("aria-label", isPinned ? "Unpin" : "Pin");
        pinButton.innerHTML = isPinned ? iconSvg("pin-on") : iconSvg("pin");
        pinButton.addEventListener("click", () => {
          const currentDate = selectedDate;
          if (isPinned) {
            const pin = state.pinnedItems.find((entry) => entry.id === item.pinId);
            if (!pin) return;
            const pinnedDone = !!(state.pinStatusByDate[currentDate] || {})[pin.id];
            pin.deletedAt = currentDate;
            const items = getItemsForDate(currentDate);
            items.push({
              id: createId(),
              title: pin.title,
              time: pin.time,
              memo: pin.memo,
              periodId: pin.periodId,
              done: pinnedDone,
              createdAt: Date.now(),
            });
            savePinsState();
            saveState(currentDate);
            render();
            return;
          }
          const pinId = createId();
          const nextPin = {
            id: pinId,
            title: item.title,
            time: item.time,
            memo: item.memo,
            periodId: item.periodId,
            createdAt: currentDate,
          };
          state.pinnedItems.push(nextPin);
          state.itemsByDate[currentDate] = getItemsForDate(currentDate).filter(
            (entry) => entry.id !== item.id
          );
          if (item.done) {
            const nextStatus = { ...(state.pinStatusByDate[currentDate] || {}) };
            nextStatus[pinId] = true;
            state.pinStatusByDate[currentDate] = nextStatus;
            savePinStatus(currentDate);
          }
          saveState(currentDate);
          savePinsState();
          render();
        });
        actions.appendChild(pinButton);

        const move = document.createElement("button");
        move.type = "button";
        move.className = "move";
        move.setAttribute("aria-label", "Move to next time");
        move.textContent = "↧";
        move.addEventListener("click", async () => {
          if (isPinned) {
            const pin = state.pinnedItems.find((entry) => entry.id === item.pinId);
            if (!pin) return;
            const action = await openPinActionModal({
              title: "MOVE PINNED ROUTINE",
              allLabel: "Move for all dates",
              futureLabel: "Move from today",
              todayLabel: "Move only today",
            });
            if (action === "cancel") return;
            const targetPeriod = getNextPeriodId(pin.periodId);
            applyPinMove(pin, targetPeriod, action);
            return;
          }
          const currentDate = selectedDate;
          const nextPeriod = getNextPeriodId(item.periodId);
          const targetDate =
            item.periodId === "evening" && nextPeriod === "morning"
              ? shiftDateKey(currentDate, 1)
              : currentDate;
          const currentItems = getItemsForDate(currentDate);
          state.itemsByDate[currentDate] = currentItems.filter(
            (entry) => entry.id !== item.id
          );
          item.periodId = nextPeriod;
          item.done = false;
          getItemsForDate(targetDate).push(item);
          saveState(currentDate);
          if (targetDate !== currentDate) saveState(targetDate);
          render();
        });

        const movePrev = document.createElement("button");
        movePrev.type = "button";
        movePrev.className = "move";
        movePrev.setAttribute("aria-label", "Move to previous time");
        movePrev.textContent = "↥";
        movePrev.addEventListener("click", async () => {
          if (isPinned) {
            const pin = state.pinnedItems.find((entry) => entry.id === item.pinId);
            if (!pin) return;
            const action = await openPinActionModal({
              title: "MOVE PINNED ROUTINE",
              allLabel: "Move for all dates",
              futureLabel: "Move from today",
              todayLabel: "Move only today",
            });
            if (action === "cancel") return;
            const targetPeriod = getPrevPeriodId(pin.periodId);
            applyPinMove(pin, targetPeriod, action);
            return;
          }
          const currentDate = selectedDate;
          const prevPeriod = getPrevPeriodId(item.periodId);
          const targetDate =
            item.periodId === "morning" && prevPeriod === "evening"
              ? shiftDateKey(currentDate, -1)
              : currentDate;
          const currentItems = getItemsForDate(currentDate);
          state.itemsByDate[currentDate] = currentItems.filter(
            (entry) => entry.id !== item.id
          );
          item.periodId = prevPeriod;
          item.done = false;
          getItemsForDate(targetDate).push(item);
          saveState(currentDate);
          if (targetDate !== currentDate) saveState(targetDate);
          render();
        });

        const remove = document.createElement("button");
        remove.type = "button";
        remove.className = "delete";
        remove.setAttribute("aria-label", "Delete todo");
        remove.textContent = "✕";
        remove.addEventListener("click", async () => {
          if (isPinned) {
            const pin = state.pinnedItems.find((entry) => entry.id === item.pinId);
            if (!pin) return;
            const action = await openPinActionModal({
              title: "DELETE PINNED ROUTINE",
              allLabel: "Delete for all dates",
              futureLabel: "Delete from today",
              todayLabel: "Delete only today",
            });
            if (action === "cancel") return;
            applyPinDelete(pin, action);
            return;
          }
          const items = getItemsForDate(selectedDate);
          state.itemsByDate[selectedDate] = items.filter(
            (entry) => entry.id !== item.id
          );
          saveState();
          render();
        });

        actions.appendChild(movePrev);
        actions.appendChild(move);
        actions.appendChild(remove);

        wrapper.appendChild(checkbox);
        wrapper.appendChild(label);
        wrapper.appendChild(actions);

        wrapper.addEventListener("click", (event) => {
          if (
            event.target.closest("button") ||
            event.target.closest("input") ||
            event.target.tagName === "LABEL"
          ) {
            return;
          }
          const targetItem = isPinned
            ? state.pinnedItems.find((entry) => entry.id === item.pinId)
            : item;
          if (!targetItem) return;
          openTodoEditModal(targetItem).then((action) => {
            if (action === "save") {
              if (isPinned) {
                savePinsState();
              } else {
                saveState();
              }
              render();
            }
          });
        });

        return wrapper;
      }

      function renderSection(period) {
        const section = document.createElement("section");
        section.className = "section";

        const header = document.createElement("header");
        const h2 = document.createElement("h2");
        h2.innerHTML = `${iconSvg(period.id)}<span class="sr-only">${period.label}</span>`;
        const range = document.createElement("span");
        range.className = "range";
        range.textContent = period.range;
        h2.appendChild(range);
        header.appendChild(h2);

        const toggle = document.createElement("button");
        toggle.type = "button";
        toggle.className = "add-toggle";
        toggle.setAttribute(
          "aria-label",
          openAdders[period.id] ? "Close" : "Add todo"
        );
        toggle.innerHTML = openAdders[period.id] ? iconSvg("close") : iconSvg("plus");
        toggle.addEventListener("click", () => {
          const isOpen = !!openAdders[period.id];
          Object.keys(openAdders).forEach((key) => {
            openAdders[key] = false;
          });
          openAdders[period.id] = !isOpen;
          render();
        });
        header.appendChild(toggle);

        const adder = document.createElement("form");
        adder.className = `adder${openAdders[period.id] ? "" : " hidden"}`;

        const titleInput = document.createElement("input");
        titleInput.type = "text";
        titleInput.placeholder = "NAME";
        titleInput.required = true;
        titleInput.autocomplete = "off";
        titleInput.classList.add("fit-text");
        titleInput.dataset.fitMin = "12";
        titleInput.addEventListener("input", () => fitText(titleInput, 12));

        const row = document.createElement("div");
        row.className = "row";

        const timeInput = document.createElement("input");
        timeInput.type = "time";
        timeInput.placeholder = "TIME (optional)";

        const memoGroup = document.createElement("div");
        memoGroup.className = "memo-group";

        const memoInput = document.createElement("input");
        memoInput.type = "text";
        memoInput.placeholder = "MEMO (optional)";
        memoInput.classList.add("fit-text");
        memoInput.dataset.fitMin = "12";
        memoInput.addEventListener("input", () => fitText(memoInput, 12));

        const submit = document.createElement("button");
        submit.type = "submit";
        submit.setAttribute("aria-label", "Add");
        submit.innerHTML = iconSvg("plus");

        memoGroup.appendChild(memoInput);
        memoGroup.appendChild(submit);

        row.appendChild(timeInput);
        row.appendChild(memoGroup);

        adder.appendChild(titleInput);
        adder.appendChild(row);

        adder.addEventListener("submit", (event) => {
          event.preventDefault();
          const title = titleInput.value.trim();
          if (!title) return;

          const items = getItemsForDate(selectedDate);
          items.push({
            id: createId(),
            title,
            time: timeInput.value,
            memo: memoInput.value.trim(),
            periodId: period.id,
            done: false,
            createdAt: Date.now(),
          });

          titleInput.value = "";
          timeInput.value = "";
          memoInput.value = "";
          titleInput.focus();

          saveState();
          render();
        });

        const list = document.createElement("div");
        list.className = "list";

        const pinnedItems = getPinnedForPeriod(period.id);
        const items = getItemsForDate(selectedDate)
          .filter((item) => item.periodId === period.id)
          .sort((a, b) => {
            if (a.done === b.done) return a.createdAt - b.createdAt;
            return a.done ? 1 : -1;
          });

        const merged = [...pinnedItems, ...items];

        if (merged.length === 0) {
          const empty = document.createElement("div");
          empty.className = "empty";
          empty.textContent = "-";
          list.appendChild(empty);
        } else {
          merged.forEach((item) => list.appendChild(createTodoElement(item)));
        }

        section.appendChild(header);
        section.appendChild(adder);
        section.appendChild(list);

        return section;
      }

      function renderDailyMemoSection() {
        const section = document.createElement("section");
        section.className = "section memo";

        const header = document.createElement("header");
        const h2 = document.createElement("h2");
        h2.innerHTML = `${iconSvg("pencil")}<span class="range">MEMO</span>`;
        header.appendChild(h2);

        const toggle = document.createElement("button");
        toggle.type = "button";
        toggle.className = "add-toggle";
        toggle.setAttribute("aria-label", openMemoAdder ? "Close" : "Add memo");
        toggle.innerHTML = openMemoAdder ? iconSvg("close") : iconSvg("plus");
        toggle.addEventListener("click", () => {
          openMemoAdder = !openMemoAdder;
          render();
        });
        header.appendChild(toggle);

        const adder = document.createElement("form");
        adder.className = `adder${openMemoAdder ? "" : " hidden"}`;

        const memoInput = document.createElement("input");
        memoInput.type = "text";
        memoInput.placeholder = "Say something...";
        memoInput.classList.add("fit-text");
        memoInput.dataset.fitMin = "12";
        memoInput.addEventListener("input", () => fitText(memoInput, 12));

        const submit = document.createElement("button");
        submit.type = "submit";
        submit.setAttribute("aria-label", "Add");
        submit.innerHTML = iconSvg("plus");

        adder.appendChild(memoInput);
        adder.appendChild(submit);

        adder.addEventListener("submit", (event) => {
          event.preventDefault();
          const text = memoInput.value.trim();
          if (!text) return;
          const items = state.memoItemsByDate[selectedDate] || [];
          items.push({ id: createId(), text, createdAt: Date.now() });
          state.memoItemsByDate[selectedDate] = items;
          memoInput.value = "";
          memoInput.focus();
          saveMemoState();
          render();
        });

        const list = document.createElement("div");
        list.className = "memo-list";
        const items = state.memoItemsByDate[selectedDate] || [];
        if (items.length === 0) {
          const empty = document.createElement("div");
          empty.className = "empty";
          empty.textContent = "-";
          list.appendChild(empty);
        } else {
          items.forEach((memo) => {
            const row = document.createElement("div");
            row.className = "memo-item";

            const text = document.createElement("div");
            text.className = "text fit-text";
            text.dataset.fitMin = "10";
            text.textContent = memo.text;

            const remove = document.createElement("button");
            remove.type = "button";
            remove.className = "delete";
            remove.setAttribute("aria-label", "Delete memo");
            remove.textContent = "✕";
            remove.addEventListener("click", () => {
              openPinActionModal({
                title: "DELETE MEMO",
                allLabel: "Delete",
                futureLabel: "",
                todayLabel: "",
                hideFuture: true,
                hideToday: true,
              }).then((action) => {
                if (action !== "all") return;
                state.memoItemsByDate[selectedDate] = items.filter(
                  (entry) => entry.id !== memo.id
                );
                saveMemoState();
                render();
              });
            });

            row.appendChild(text);
            row.appendChild(remove);
            list.appendChild(row);

            row.addEventListener("click", (event) => {
              if (event.target.closest("button")) return;
              openMemoEditModal(memo).then((action) => {
                if (action === "save") {
                  saveMemoState();
                  render();
                }
              });
            });
          });
        }

        section.appendChild(header);
        section.appendChild(adder);
        section.appendChild(list);

        return section;
      }

      function render() {
        sectionsEl.innerHTML = "";
        PERIODS.forEach((period) => {
          sectionsEl.appendChild(renderSection(period));
        });
        sectionsEl.appendChild(renderDailyMemoSection());
        fitAllText();
      }

      function getItemsForDate(dateKey) {
        if (!state.itemsByDate[dateKey]) {
          state.itemsByDate[dateKey] = [];
        }
        return state.itemsByDate[dateKey];
      }

      function setSelectedDate(value) {
        selectedDate = value;
        const label = getRelativeLabel();
        const todayClass = label === "-" ? "today hidden" : "today";
        dateCenter.innerHTML = `<div class="${todayClass}">${label}</div><div>${formatDateLabel()}</div>`;
        subscribeToDate(selectedDate);
        subscribePinStatus(selectedDate);
        subscribeMemo(selectedDate);
        render();
      }

      datePrev.addEventListener("click", () => shiftSelectedDate(-1));
      dateNext.addEventListener("click", () => shiftSelectedDate(1));
      window.addEventListener("resize", fitAllText);
      titleEl.addEventListener("click", () => setSelectedDate(getTodayKey()));
      calendarOpen.addEventListener("click", openCalendar);
      calendarPrev.addEventListener("click", () => {
        calendarMonth = new Date(
          calendarMonth.getFullYear(),
          calendarMonth.getMonth() - 1,
          1
        );
        renderCalendar();
      });
      calendarNext.addEventListener("click", () => {
        calendarMonth = new Date(
          calendarMonth.getFullYear(),
          calendarMonth.getMonth() + 1,
          1
        );
        renderCalendar();
      });
      calendarModal.addEventListener("click", (event) => {
        const target = event.target.closest(".calendar-day, .modal-backdrop");
        if (!target) return;
        if (target.classList.contains("modal-backdrop")) {
          closeCalendar();
          return;
        }
        const dateKey = target.dataset.date;
        if (!dateKey) return;
        setSelectedDate(dateKey);
        closeCalendar();
      });

      const paramDate = new URLSearchParams(window.location.search).get("date");
      if (isValidDateKey(paramDate)) {
        setSelectedDate(paramDate);
      } else {
        setSelectedDate(getTodayKey());
      }
      subscribePins();
      render();
    </script>
  </body>
</html>
