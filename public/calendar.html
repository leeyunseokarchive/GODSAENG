<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
    />
    <meta name="theme-color" content="#ffffff" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="Todo" />
    <title>GODSAENG Calendar</title>
    <link rel="manifest" href="/manifest.json" />
    <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        color-scheme: light;
        --bg: #ffffff;
        --surface: #ffffff;
        --ink: #111111;
        --muted: #6a6a6a;
        --line: #e5e5e5;
        --accent: #111111;
        --green-1: #e3efe7;
        --green-2: #bcd8c7;
        --green-3: #88b79d;
        --green-4: #4e8569;
        --radius: 18px;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Noto Sans KR", system-ui, sans-serif;
        background: var(--bg);
        color: var(--ink);
        height: 100vh;
        overflow: hidden;
        touch-action: manipulation;
      }

      .page {
        padding: 28px 18px 80px;
        max-width: 720px;
        margin: 0 auto;
        height: 100%;
        display: flex;
        flex-direction: column;
        gap: 16px;
        overflow: hidden;
      }

      header {
        display: flex;
        align-items: center;
        gap: 16px;
        margin-bottom: 22px;
      }

      header .title {
        font-family: "Noto Sans KR", sans-serif;
        font-size: 26px;
        font-weight: 600;
        letter-spacing: -0.02em;
      }

      .tabs a {
        width: 28px;
        height: 28px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 10px;
        border: 1px solid var(--line);
        background: #ffffff;
        color: var(--ink);
        text-decoration: none;
      }

      .tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 16px;
        align-items: center;
      }

      .tabs button {
        border: 1px solid var(--line);
        background: #ffffff;
        padding: 8px 12px;
        border-radius: 999px;
        font-size: 13px;
        cursor: pointer;
      }

      .tabs button.active {
        background: var(--accent);
        color: #ffffff;
      }

      .tabs .spacer {
        flex: 1;
      }

      button,
      a {
        color: var(--ink);
        touch-action: manipulation;
      }

      .panel {
        background: var(--surface);
        border: 1px solid var(--line);
        border-radius: var(--radius);
        padding: 16px;
        overflow: hidden;
      }

      .panel.hidden {
        display: none;
      }

      .month-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
      }

      .month-header h2 {
        margin: 0;
        font-size: 16px;
        font-weight: 600;
      }

      .month-header button {
        border: 1px solid var(--line);
        background: #ffffff;
        width: 28px;
        height: 28px;
        border-radius: 10px;
        cursor: pointer;
      }

      .month-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 8px;
      }

      .weekday {
        font-size: 11px;
        color: var(--muted);
        text-align: center;
      }

      .day {
        border: 1px solid var(--line);
        background: #ffffff;
        border-radius: 12px;
        padding: 8px;
        min-height: 64px;
        display: grid;
        gap: 6px;
        text-decoration: none;
        color: inherit;
      }

      .day.empty {
        border: none;
        background: transparent;
      }

      .day .num {
        font-size: 13px;
        font-weight: 600;
      }

      .day .stats {
        font-size: 11px;
        color: var(--muted);
      }

      .day.today {
        border-color: var(--ink);
        box-shadow: inset 0 0 0 1px var(--ink);
      }

      .level-0 {
        background: #ffffff;
      }

      .level-1 {
        background: var(--green-1);
      }

      .level-2 {
        background: var(--green-2);
      }

      .level-3 {
        background: var(--green-3);
      }

      .level-4 {
        background: var(--green-4);
        color: #ffffff;
      }

      .year-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 10px;
      }

      .year-header h2 {
        margin: 0;
        font-size: 16px;
        font-weight: 600;
      }

      .year-header button {
        border: 1px solid var(--line);
        background: #ffffff;
        width: 28px;
        height: 28px;
        border-radius: 10px;
        cursor: pointer;
      }

      .heatmap {
        display: grid;
        grid-auto-flow: column;
        grid-template-rows: repeat(7, 12px);
        gap: 4px;
        overflow-x: auto;
        overflow-y: hidden;
        padding-bottom: 4px;
      }

      .cell {
        width: 12px;
        height: 12px;
        border-radius: 3px;
        background: #f0f0f0;
        text-decoration: none;
        display: block;
      }

      .cell.level-1 {
        background: var(--green-1);
      }

      .cell.level-2 {
        background: var(--green-2);
      }

      .cell.level-3 {
        background: var(--green-3);
      }

      .cell.level-4 {
        background: var(--green-4);
      }

      .legend {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 11px;
        color: var(--muted);
        margin-top: 10px;
      }

      .icon {
        width: 16px;
        height: 16px;
        display: block;
        fill: currentColor;
      }

      @media (max-width: 600px) {
        .page {
          padding: 24px 14px 80px;
        }
      }
    </style>
  </head>
  <body>
    <main class="page">
      <header>
        <div class="title">CALENDAR</div>
      </header>

      <div class="tabs">
        <button id="tab-month" class="active" type="button">M</button>
        <button id="tab-year" type="button">Y</button>
        <div class="spacer"></div>
        <a href="index.html" aria-label="메인으로">
          <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
            <path
              d="M12 4.5a1 1 0 0 1 .7.29l7 6.8a1 1 0 1 1-1.4 1.42L18 12.7V19a1 1 0 0 1-1 1h-3.5a1 1 0 0 1-1-1v-4.5h-1V19a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1v-6.3l-.3.3a1 1 0 1 1-1.4-1.42l7-6.8a1 1 0 0 1 .7-.29Z"
            />
          </svg>
        </a>
      </div>

      <section id="panel-month" class="panel">
        <div class="month-header">
          <button id="month-prev" type="button">◀</button>
          <h2 id="month-label"></h2>
          <button id="month-next" type="button">▶</button>
        </div>
        <div class="month-grid" id="month-grid"></div>
      </section>

      <section id="panel-year" class="panel hidden">
        <div class="year-header">
          <button id="year-prev" type="button">◀</button>
          <h2 id="year-label"></h2>
          <button id="year-next" type="button">▶</button>
        </div>
        <div class="heatmap" id="year-heatmap"></div>
        <div class="legend">
          LOW
          <span class="cell level-1"></span>
          <span class="cell level-2"></span>
          <span class="cell level-3"></span>
          <span class="cell level-4"></span>
          HIGH
        </div>
      </section>
    </main>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        query,
        where,
        getDocs,
        documentId,
      } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyCngHRQF5RAA-_98Xfv08AXRfUZNB9bNRI",
        authDomain: "swipetodo.firebaseapp.com",
        projectId: "swipetodo",
        storageBucket: "swipetodo.firebasestorage.app",
        messagingSenderId: "245873687078",
        appId: "1:245873687078:web:a9b6facdea2eb2587fc4e7",
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      let lastTouchEnd = 0;
      document.addEventListener("gesturestart", (event) => event.preventDefault());
      document.addEventListener("gesturechange", (event) => event.preventDefault());
      document.addEventListener("gestureend", (event) => event.preventDefault());
      document.addEventListener(
        "touchend",
        (event) => {
          const now = Date.now();
          if (now - lastTouchEnd <= 300) {
            event.preventDefault();
          }
          lastTouchEnd = now;
        },
        { passive: false }
      );
      const STORAGE_KEY = "todays-todos";
      const DAYS = ["SUN", "MON", "TUE", "WED", "THU", "FRI", "SAT"];

      const tabMonth = document.getElementById("tab-month");
      const tabYear = document.getElementById("tab-year");
      const panelMonth = document.getElementById("panel-month");
      const panelYear = document.getElementById("panel-year");

      const monthGrid = document.getElementById("month-grid");
      const monthLabel = document.getElementById("month-label");
      const monthPrev = document.getElementById("month-prev");
      const monthNext = document.getElementById("month-next");

      const yearLabel = document.getElementById("year-label");
      const yearPrev = document.getElementById("year-prev");
      const yearNext = document.getElementById("year-next");
      const yearHeatmap = document.getElementById("year-heatmap");

      const state = loadState();
      let currentMonth = new Date();
      let currentYear = new Date().getFullYear();
      const loadedYears = new Set();

      function loadState() {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return { itemsByDate: {} };
        try {
          const parsed = JSON.parse(raw);
          if (parsed.itemsByDate) {
            return { itemsByDate: parsed.itemsByDate };
          }
          if (parsed.date && Array.isArray(parsed.items)) {
            return { itemsByDate: { [parsed.date]: parsed.items } };
          }
          return { itemsByDate: {} };
        } catch (error) {
          return { itemsByDate: {} };
        }
      }

      function ensureYearLoaded(year) {
        if (loadedYears.has(year)) return;
        loadedYears.add(year);
        const startKey = `${year}-01-01`;
        const endKey = `${year}-12-31`;
        const todosRef = collection(db, "todos");
        const q = query(
          todosRef,
          where(documentId(), ">=", startKey),
          where(documentId(), "<=", endKey)
        );
        getDocs(q)
          .then((snapshot) => {
            snapshot.forEach((doc) => {
              const data = doc.data() || {};
              const items = Array.isArray(data.items) ? data.items : [];
              state.itemsByDate[doc.id] = items;
            });
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
            renderMonth();
            renderYear();
          })
          .catch((error) => console.warn("Firestore load failed", error));
      }

      function getDayStats(dateKey) {
        const items = state.itemsByDate[dateKey] || [];
        const total = items.length;
        const done = items.filter((item) => item.done).length;
        return { total, done };
      }

      function getLevel(total, done) {
        if (total === 0) return 0;
        const ratio = done / total;
        if (ratio === 0) return 1;
        if (ratio <= 0.33) return 2;
        if (ratio <= 0.66) return 3;
        return 4;
      }

      function renderMonth() {
        monthGrid.innerHTML = "";
        const year = currentMonth.getFullYear();
        const month = currentMonth.getMonth();
        ensureYearLoaded(year);
        const todayKey = new Date().toISOString().slice(0, 10);
        monthLabel.textContent = `${year}.${String(month + 1).padStart(2, "0")}`;

        DAYS.forEach((day) => {
          const label = document.createElement("div");
          label.className = "weekday";
          label.textContent = day;
          monthGrid.appendChild(label);
        });

        const first = new Date(year, month, 1);
        const startDay = first.getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        for (let i = 0; i < startDay; i += 1) {
          const empty = document.createElement("div");
          empty.className = "day empty";
          monthGrid.appendChild(empty);
        }

        for (let day = 1; day <= daysInMonth; day += 1) {
          const dateKey = `${year}-${String(month + 1).padStart(2, "0")}-${String(
            day
          ).padStart(2, "0")}`;
          const { total, done } = getDayStats(dateKey);
          const level = getLevel(total, done);

          const cell = document.createElement("a");
          cell.className = `day level-${level}${dateKey === todayKey ? " today" : ""}`;
          cell.href = `index.html?date=${dateKey}`;

          const num = document.createElement("div");
          num.className = "num";
          num.textContent = day;

          const stats = document.createElement("div");
          stats.className = "stats";
          stats.textContent = total ? `${done}/${total}` : "";

          cell.appendChild(num);
          cell.appendChild(stats);
          monthGrid.appendChild(cell);
        }
      }

      function renderYear() {
        yearLabel.textContent = `${currentYear}`;
        yearHeatmap.innerHTML = "";
        ensureYearLoaded(currentYear);

        const start = new Date(currentYear, 0, 1);
        const end = new Date(currentYear, 11, 31);

        const startSunday = new Date(start);
        startSunday.setDate(start.getDate() - start.getDay());

        for (
          let date = new Date(startSunday);
          date <= end || date.getDay() !== 0;
          date.setDate(date.getDate() + 1)
        ) {
          const inYear = date.getFullYear() === currentYear;
          const dateKey = `${date.getFullYear()}-${String(
            date.getMonth() + 1
          ).padStart(2, "0")}-${String(date.getDate()).padStart(2, "0")}`;
          const { total, done } = inYear ? getDayStats(dateKey) : { total: 0, done: 0 };
          const level = inYear ? getLevel(total, done) : 0;

          if (inYear) {
            const cell = document.createElement("a");
            cell.className = `cell level-${level}`;
            cell.title = `${dateKey} ${done}/${total}`;
            cell.href = `index.html?date=${dateKey}`;
            yearHeatmap.appendChild(cell);
          } else {
            const cell = document.createElement("div");
            cell.className = "cell";
            yearHeatmap.appendChild(cell);
          }
        }
      }

      function setTab(tab) {
        const isMonth = tab === "month";
        tabMonth.classList.toggle("active", isMonth);
        tabYear.classList.toggle("active", !isMonth);
        panelMonth.classList.toggle("hidden", !isMonth);
        panelYear.classList.toggle("hidden", isMonth);
      }

      tabMonth.addEventListener("click", () => setTab("month"));
      tabYear.addEventListener("click", () => setTab("year"));

      monthPrev.addEventListener("click", () => {
        currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1, 1);
        renderMonth();
      });

      monthNext.addEventListener("click", () => {
        currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 1);
        renderMonth();
      });

      yearPrev.addEventListener("click", () => {
        currentYear -= 1;
        renderYear();
      });

      yearNext.addEventListener("click", () => {
        currentYear += 1;
        renderYear();
      });

      renderMonth();
      renderYear();
    </script>
  </body>
</html>
